rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS - SIMPLIFIED MODEL
    // ============================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is a super admin
    function isSuperAdmin() {
      let userData = getUserData();
      return userData.isSuperAdmin == true;
    }

    // Check if user belongs to a tenant (simplified: single tenantId)
    function userBelongsToTenant(tenantId) {
      let userData = getUserData();
      return userData.tenantId == tenantId;
    }

    // Check if user is owner of tenant (simplified: check ownerId)
    function isOwnerOfTenant(tenantId) {
      let tenantData = get(/databases/$(database)/documents/tenants/$(tenantId)).data;
      return tenantData.ownerId == request.auth.uid;
    }

    // Check if document belongs to user's tenant
    function belongsToUserTenant(tenantId) {
      return isAuthenticated() && userBelongsToTenant(tenantId);
    }

    // ============================================================================
    // USERS COLLECTION
    // ============================================================================

    match /users/{userId} {
      // Super admins can read all users, or users can read their own document
      allow read: if isAuthenticated() && (isSuperAdmin() || request.auth.uid == userId);

      // Users can update their own document
      // Super admins can update any user
      allow update: if isAuthenticated() &&
                       (isSuperAdmin() || request.auth.uid == userId);

      // User document is created by Firebase extension - no direct writes
      allow create: if isAuthenticated();
      allow delete: if isSuperAdmin();
    }

    // ============================================================================
    // TENANTS COLLECTION
    // ============================================================================

    match /tenants/{tenantId} {
      // Super admins can read all tenants, or users can read their own tenant
      allow read: if isAuthenticated() && (isSuperAdmin() || userBelongsToTenant(tenantId));

      // Authenticated users can create a tenant (onboarding)
      allow create: if isAuthenticated();

      // Super admins or owner can update tenant
      allow update: if isAuthenticated() && (isSuperAdmin() || isOwnerOfTenant(tenantId));

      // Super admins or owner can delete tenant
      allow delete: if isAuthenticated() && (isSuperAdmin() || isOwnerOfTenant(tenantId));
    }

    // ============================================================================
    // TENANT DATA COLLECTIONS
    // ============================================================================

    // Generic rule for all tenant-scoped collections
    function canAccessTenantData(tenantId) {
      return isAuthenticated() &&
             belongsToUserTenant(tenantId) &&
             request.resource.data.tenantId == tenantId;
    }

    function canModifyTenantData(tenantId) {
      return isAuthenticated() &&
             belongsToUserTenant(tenantId) &&
             resource.data.tenantId == tenantId;
    }

    // Clientes
    match /clientes/{clienteId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Vehiculos
    match /vehiculos/{vehiculoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Trabajos
    match /trabajos/{trabajoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Turnos
    match /turnos/{turnoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Productos
    match /productos/{productoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Presupuestos
    match /presupuestos/{presupuestoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // Movimientos de Caja
    match /movimientos_caja/{movimientoId} {
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || belongsToUserTenant(resource.data.tenantId));

      allow create: if canAccessTenantData(request.resource.data.tenantId);

      allow update, delete: if isSuperAdmin() || canModifyTenantData(resource.data.tenantId);
    }

    // ============================================================================
    // TENANT COUNTERS - Work order number generation
    // ============================================================================

    match /tenant-counters/{tenantId} {
      // Read: Only users belonging to the tenant or super admin
      allow read: if isAuthenticated() &&
                     (isSuperAdmin() || userBelongsToTenant(tenantId));

      // Create/Update: Only users belonging to the tenant can initialize or update via transactions
      // The counter document ID must match the tenantId
      allow create, update: if isAuthenticated() &&
                               userBelongsToTenant(tenantId);

      // Delete: Only super admin can delete counters
      allow delete: if isSuperAdmin();
    }

    // ============================================================================
    // DEFAULT DENY ALL
    // ============================================================================

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
